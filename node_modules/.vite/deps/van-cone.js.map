{
  "version": 3,
  "sources": ["../../van-cone/src/spa.js"],
  "sourcesContent": ["import van from \"vanjs-core\";\nconst { a } = van.tags;\n\nconst parametersPattern = /(:[^\\/]+)/g;\n\nfunction getMatchedParams(route, path) {\n\tconst matches = path.match(route.matcher);\n\n\tif (!matches) {\n\t\treturn false;\n\t}\n\n\treturn route.params.reduce((acc, param, idx) => {\n\t\tacc[param] = decodeURIComponent(matches[idx + 1]);\n\t\treturn acc;\n\t}, {});\n};\n\nfunction getQueryParams(query) {\n\treturn query.split('&')\n\t\t.filter(p => p.length)\n\t\t.reduce((acc, part) => {\n\t\t\tconst [key, value] = part.split('=');\n\t\t\tacc[decodeURIComponent(key)] = decodeURIComponent(value);\n\t\t\treturn acc;\n\t\t}, {});\n};\n\nfunction createRoute(name, path, backend, handler) {\n\tconst matcher = new RegExp(path.replace(parametersPattern, '([^\\/]+)') + '$');\n\tconst params = (path.match(parametersPattern) || []).map(x => x.substring(1));\n\treturn {name, path, handler, backend, matcher, params};\n};\n\nconst findRouteParams = (routes, path) => {\n\tlet params;\n\tconst route = routes.find(r => params = getMatchedParams(r, path));\n\treturn {route, params};\n};\n\nconst parseUrl = (url) => {\n\tconst [path, queryString] = url.split('?');\n\treturn {path, queryString};\n};\n\nconst stripPrefix = (url, prefix) => url.replace(new RegExp('^' + prefix), '');\n\nclass Router {\n\n\tconstructor(config) {\n\t\tthis.routes = [];\n\t\tthis.prefix = config && config.prefix || '';\n        this.backendPrefix = config && config.backendPrefix || '';\n\t}\n\n\tadd(name, path, backend, handler) {\n\t\tthis.routes.push(createRoute(name, path, backend, handler));\n\t\treturn this;\n\t}\n\n\tdispatch(url, context) {\n        console.debug('Router.dispatching', url)\n\t\tconst {path, queryString} = parseUrl(stripPrefix(url, this.prefix));\n        console.debug(path, queryString)\n\t\tconst query = getQueryParams(queryString || '');\n\t\tconst {route, params} = findRouteParams(this.routes, path);\n\n\t\tif (route) {\n\t\t\troute.handler({params, query, context});\n\t\t\treturn route;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tgetRoute(url) {\n\t\tconst {path, queryString} = parseUrl(stripPrefix(url, this.prefix));\n\t\tconst rp = findRouteParams(this.routes, path);\n\t\treturn rp && rp.route;\n\t}\n\n\t_formatUrl(routeName, isBackend, params = {}, query = {}) {\n\t\tconst route = this.routes.find(r => r.name === routeName);\n\n\t\tif (!route) {\n\t\t\tthrow new Error(`Route ${routeName} not found`);\n\t\t}\n\n\t\tconst queryString = Object.keys(query)\n\t\t\t\t  .map(k => [k, query[k]])\n\t\t\t\t  .map(([k, v]) => encodeURIComponent(k) + '=' + encodeURIComponent(v))\n\t\t\t\t  .join('&');\n\n\n        const prefix = (isBackend === true) ? this.backendPrefix : this.prefix\n        const routePath = (isBackend && route.backend) ? route.backend : route.path\n\n\t\tconst path = prefix + routePath.replace(parametersPattern, function(match) {\n\t\t\treturn params[match.substring(1)];\n\t\t});\n\n\t\treturn queryString.length ? path + '?' + queryString : path;\n\t}\n\n    navUrl(routeName, params = {}, query = {}) {\n\t\treturn this._formatUrl(routeName, false, params, query)\n\t}\n\n    backendUrl(routeName, params = {}, query = {}) {\n\t\treturn this._formatUrl(routeName, true, params, query)\n\t}\n};\n\n\nfunction createCone(routerElement, routes, defaultNavState, routerConfig) {\n\n    const currentPage = van.state(\"\")\n\n    const isCurrentPage = (pageName) => van.derive(() => currentPage.val === pageName)\n\n    // router\n    const router = new Router(routerConfig);\n\n    routes.forEach(route => {\n        router.add(route.name, route.path, route.backend, function({params, query, context}) {\n            console.debug(\"VanSpa.router.action to \" + route.name)\n\n            currentPage.val = route.name\n            if (route.title) window.document.title = route.title\n\n            const _params = params || {}\n            const _query = query || {}\n            const _context = context || {} \n\n            route.callable()\n                .then((page) => {\n                    if ('default' in page) {\n                        return routerElement.replaceChildren(page.default(_params, _query, _context)())\n                    }else{\n                        return routerElement.replaceChildren(page(_params, _query, _context))\n                    }\n                }).catch((error) => console.error('error changing page', error))\n        });\n    })\n\n    // nav state\n    const _defaultNavState = typeof defaultNavState === 'undefined' ? null : defaultNavState\n    const navState = van.state(_defaultNavState)\n\n    const getNavState = () => navState.val\n\n    const setNavState = (newState) => {\n        if(newState === null) {\n            navState.val = defaultNavState\n        }else{\n            navState.val = newState\n        }\n    }\n\n    // window navigation events\n    window.onpopstate = (event) => {\n        console.debug(\"VanSpa.popstate:\", event.target.location.href)\n        router.dispatch(event.target.location.href)\n    };\n\n    window.onload = (event) => {\n        console.debug(\"window.onload\", event.target.location.href, window.history.state)\n        setNavState(window.history.state)\n        router.dispatch(event.target.location.href)\n    }\n\n    // navigation functions\n    const navigate = (url, context) => {\n        console.debug(\"VanSpa.navigate\", url)\n        history.pushState(getNavState(), \"\", url);\n        router.dispatch(url, context)\n    } \n\n    const pushHistory = (url) => {\n        console.debug(\"VanSpa.pushHistory\", url)\n        history.pushState(getNavState(), \"\", url)\n    } \n      \n    const handleNav = (event, context) => {\n        event.preventDefault();\n        console.debug(\"VanSpa.handleNav\", event.target.href)\n        navigate(event.target.href, context)\n    }\n\n    // nav link component\n    function navLink(props, ...children) {\n        const { target, name, params, query, context, ...otherProps } = props;\n\n        return a(\n            {\n                \"aria-current\": van.derive(() => (isCurrentPage(name).val ? \"page\" : \"\")),\n                href: router.navUrl(name, params, query),\n                target: target || \"_self\",\n                role: \"link\",\n                class: otherProps.class || 'router-link',\n                onclick: (event) => handleNav(event, context),\n                ...otherProps,\n            },\n            children\n        );\n    };\n\n    return {\n        routerElement,\n        currentPage,\n        router,\n        navState,\n        getNavState,\n        setNavState,\n        navigate,\n        pushHistory,\n        handleNav,\n        isCurrentPage,\n        navLink\n    }\n}\n\nexport default createCone"],
  "mappings": "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",
  "names": []
}
